<!DOCTYPE html>
<html lang="en" translate="no">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
<meta name="google" content="notranslate">
    <title>Home</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>

<style type="text/css">
.goog-te-banner-frame.skiptranslate {
    display: none !important;
    } 
    .navbar{
      position:fixed;
      left:0;
      right:0;
      top:0;
      z-index: 999;
    }
.footer {
display:none;
position:fixed;
bottom:0;
left:0;
right:0;
background: #1e1e1e;
}
body{
  background:rgb(10,10,10);
}
.footer input {
flex-grow:1;
background-color: transparent!important;
outline:none;
color: white;
}
.footer input , .footer button{
padding:12px;
font-size:16px;
border: none;
outline: none;
background-color: transparent!important;
}

#login-signup{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
}
#chat{
padding:12px;
font-size:16px;
padding-bottom: 56px;
padding-top: 84px;
display:flex;
flex-direction: column;
}
    #chat>div>div{
        border-bottom:2px solid black;
        border-radius:20px;
        background-color:rgba(255,255,255,0.1);
        padding:5px 13px;
       
        color:white;
        max-width: 80%;
       
        word-wrap: break-word;
    }
    #chat>div>div.self{
      float: right;
      
    }
    
    #chat div span {
      display: block;
      font-size: 10px;
      float: right;
      bottom: 0;
      position: relative ;
      color: floralwhite;
      display:flex;
      padding-top:10px;
      padding-bottom:0;
      padding-left:8px;
    }
    #chat div b{
      
      color: #4caf50;
    }
    #chat>div>div.self b{
      
      display: none
    }
    #chat::-webkit-scrollbar {
display: none;
}
#chat {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
}
</style>

</head>

<body class=""  >
<nav class="navbar navbar-dark bg-dark navbar-expand-sm flex-nowrap align-items-start">

  
<div class="d-flex flex-column">
      <a class="navbar-brand mr-auto" href="#">Chatroom</a>
    <small id="status" style="color: white">...</small>
  </div>
</nav>


    <div id="login-signup">
        <input class="form-control" type="text" id="username" placeholder="Enter Username" > <br>
        <input class="form-control" type="text" id="password" placeholder="Enter Password" > <br>

        <button class="signup btn btn-primary">Login</button> <br> <br>
    </div>
    <section id="area" >
            <div id="chat"></div>
<section class="footer">
<input type="text" id="message" placeholder="Type your message">
<button class="send-message"><svg fill="white" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="mdi mdi-send" width="24" height="24" viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg></button>
</section>
</section>
    <script type="text/javascript" src="app.js"></script>
</body>

<script type="text/javascript">
function req(){// The latest spec has updated this method to a promise-based syntax that works like this:
Notification.requestPermission();

// Previously, the syntax was based on a simple callback; this version is now deprecated:
Notification.requestPermission(callback);
}

var config = {
    apiKey: "AIzaSyBxjh9aWtXpq7ki3d8JOCknMtMEbn9Ze5Y",
    authDomain: "re96ev.firebaseapp.com",
    databaseURL: "https://re96ev-default-rtdb.firebaseio.com",
    projectId: "re96ev",
    storageBucket: "re96ev.appspot.com",
    messagingSenderId: "898951921391",
    appId: "1:898951921391:web:adbba9db68380d3ec0651a",
    measurementId: "G-FPP98JDRNZ"
};
firebase.initializeApp(config);
    $("#area").hide();
    document.querySelector('.footer').style.display = "none";
var db = firebase.database();



$(".signup").on("click", function (event) {
    event.preventDefault();

    var username = $("#username").val().trim();
    var password = $("#password").val().trim();

    createUser(username, password);
});

$(".send-message").on("click", function (event) {
    event.preventDefault();
               var inputField = document.getElementById('message');
        inputField.focus();
    var message = $("#message").val().trim();
    var username = getCookie('id');

    if (message && username) {
        sendMessage(username, message);
        $("#message").val(""); // Clear the message input after sending
    } else {
        alert("Please enter a message and log in first");
    }
});

function loginUser(username, password) {
    var userRef = db.ref("members/" + username);

    userRef.once("value")
        .then(function (snapshot) {
            var user = snapshot.val();
            if (user && user.password === password) {
                hideLoginSignup();
                listenForMessages();
                saveCookie('id', username, 365); // Saves 'myCookie' with value 'cookieValue' that expires in 7 days
                saveCookie('pwd', password, 365); 
                console.log(getCookie("id"));
                var userStatusRef = firebase.database().ref('members/' + username + '/status');
                  firebase.database().ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val()) {
                    userStatusRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);                      userStatusRef.set('online');
                    }
                  });
            } else {
                alert("Invalid username or password");
            }
        })
        .catch(function (error) {
            console.error("Error logging in:", error);
        });
        
}

function createUser(username, password) {
    var userRef = db.ref("members/" + username);

    userRef.once("value")
        .then(function (snapshot) {
            var user = snapshot.val();

            if (user) {
                console.log("User already exists");
                loginUser(username, password);
            } else {
                // Create user
                userRef.set({
                    password: password
                }, function (error) {
                    if (error) {
                        console.error("Error creating user:", error);
                    } else {
                    saveCookie('id', username, 365); // Saves 'myCookie' with value 'cookieValue' that expires in 7 days
                     saveCookie('pwd', password, 365); 
                
                        hideLoginSignup();
                        listenForMessages();
                    }
                });
            }
        })
        .catch(function (error) {
            console.error("Error creating user:", error);
        });
}

function hideLoginSignup() {
    $("#login-signup").hide();
        $("#area").show();
            document.querySelector('.footer').style.display = "flex";
}

function sendMessage(username, message) {
    var chatRef = db.ref("chat");
    var timestamp = firebase.database.ServerValue.TIMESTAMP;

    chatRef.push({
        username: username,
        message: message,
        timestamp: timestamp
    });
}

function listenForMessages() {
    var chatRef = db.ref("chat");

    chatRef.on("child_added", function (snapshot) {
        var message = snapshot.val();
        
        displayMessage(message.username, message.message, message.timestamp);
    });
}

function displayMessage(username, message, timestamp) {
    var chatDiv = document.getElementById("chat");
    var messageDiv_parent = document.createElement("div");

    var messageDiv = document.createElement("div");
if(username  == getCookie("id")){
  messageDiv.classList += "self";
  
}
    // Check for links in the message and convert them to clickable HTML links
    var messageWithLinks = convertLinks(message);

    // If there are no links, use the original message
    messageWithLinks = messageWithLinks || message;

    messageDiv.innerHTML =
        "<b>" + username + ":</b> " + messageWithLinks + "<span>" + formatDate(timestamp) + "</span>";
    messageDiv_parent.appendChild(messageDiv);

    chatDiv.appendChild(messageDiv_parent);
    scrollToBottom();
    // You may want to enhance this further, such as scrolling to the latest message.
    // For simplicity, this example just appends messages to the chat div.
}

function convertLinks(message) {
    // Regular expression to find URLs within the message
    var urlRegex = /(https?:\/\/[^\s]+)/g;

    // Replace URLs with clickable HTML links
    var messageWithLinks = message.replace(urlRegex, function (url) {
        return '<a href="' + url + '" target="_blank">' + url + '</a>';
    });

    return messageWithLinks;
}


function formatDate(milliseconds) {
  const date = new Date(milliseconds);

  const options = {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  };

  return new Intl.DateTimeFormat('en-US', options).format(date);
}
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
function saveCookie(cname, cvalue, exdays) {
  const d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  let expires = "expires="+ d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}
function cookieExists(name) {
    return document.cookie.split(';').some(cookie => cookie.trim().startsWith(name + '='));
}
function scrollToBottom() {
    var chatDiv = document.getElementById("chat");
    chatDiv.scrollTo(0,chatDiv.scrollHeight);
    window.scrollTo(0, document.body.scrollHeight);

}

// Reference to the members' status in the database
var currentUserId = getCookie('id');

// Reference to the members' status in the database
var membersStatusRef = firebase.database().ref('/members');

// Render combined status string
function renderCombinedStatus(usersStatus) {
  var combinedStatusString = '';

  for (var userId in usersStatus) {
    if (userId !== currentUserId) {
      combinedStatusString += userId + ": " + getLastSeenString(usersStatus[userId].status) + ', ';
    }
  }

  // Remove trailing comma and space
  combinedStatusString = combinedStatusString.replace(/, $/, '');

  console.log(combinedStatusString);
  document.querySelector('#status').innerText = combinedStatusString;
  // Update your UI or perform any other action with the combined status string
}

// Set up real-time listener
membersStatusRef.on('value', function(snapshot) {
  var usersStatus = snapshot.val();
  renderCombinedStatus(usersStatus);
});

function getLastSeenString(lastSeenTimestamp) {
  if (lastSeenTimestamp === 'online') {
    return 'Online';
  } else {
    var lastSeenDate = new Date(lastSeenTimestamp);
    var currentDate = new Date();
    var timeDifference = currentDate - lastSeenDate;

    if (timeDifference < 24 * 60 * 60 * 1000) {
      // Less than 24 hours ago
      var formattedTime = lastSeenDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      return 'Last seen ' + formattedTime;
    } else if (timeDifference < 2 * 24 * 60 * 60 * 1000) {
      // Less than 48 hours ago
      return 'Last seen yesterday ' + lastSeenDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    } else {
      // More than 48 hours ago
      var formattedDate = lastSeenDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
      var formattedTime = lastSeenDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      return 'Last seen on ' + formattedDate + ' at ' + formattedTime;
    }
  }
}
</script>
<script>

if (cookieExists('id')) {
$("#login-signup").hide();
        $('#area').show();
        
const id = getCookie('id');
const pwd = getCookie('pwd');
    loginUser(id, pwd);
}else{
    document.querySelector('.footer').style.display = "none";
}


</script>
</html>
