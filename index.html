<!DOCTYPE html>
<html lang="en" translate="no">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
<meta name="google" content="notranslate">
    <title>Home</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>

<style type="text/css">
.goog-te-banner-frame.skiptranslate {
    display: none !important;
    } 
    .navbar{
      position:fixed;
      left:0;
      right:0;
      top:0;
      z-index: 999;
    }
.footer {
display:none;
position:fixed;
bottom:0;
left:0;
right:0;
background: #1e1e1e;
}
body{
  background:rgb(10,10,10);
}
.footer input {
flex-grow:1;
background-color: transparent!important;
outline:none;
color: white;
}
.footer input , .footer button{
padding:12px;
font-size:16px;
border: none;
outline: none;
background-color: transparent!important;
}

#login-signup{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
}
#chat{
padding:12px;
font-size:16px;
padding-bottom: 56px;
padding-top: 84px;
display:flex;
flex-direction: column;
}
    #chat>div>div{
        border-bottom:2px solid black;
        border-radius:20px;
        background-color:rgba(255,255,255,0.1);
        padding:5px 13px;
       
        color:white;
        max-width: 80%;
       
        word-wrap: break-word;
    }
    #chat>div>div.self{
      float: right;
      
    }
    
    #chat div span {
      display: block;
      font-size: 10px;
      float: right;
      bottom: 0;
      position: relative ;
      color: floralwhite;
      display:flex;
      padding-top:10px;
      padding-bottom:0;
      padding-left:8px;
    }
    #chat div b{
      
      color: #4caf50;
    }
    #chat>div>div.self b{
      
      display: none
    }
    #chat::-webkit-scrollbar {
display: none;
}
#chat {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
}
small{
  
  overflow: hidden;
  
}
</style>

</head>

<body class=""  >
<nav class="d-flex flex-row navbar navbar-dark bg-dark navbar-expand-sm  align-items-start">

<div class="d-flex flex-fill flex-column" >
<div class="d-flex flex-row align-items-center">

      <a class="navbar-brand mr-auto flex-fill" href="#">Chatroom</a>
<svg data-toggle="modal" data-target="#exampleModal" height="28px" width="28px"  xmlns="http://www.w3.org/2000/svg"  fill="white" class="bi bi-list" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
</svg>
   </div>
    <small id="status" style="color: white">...</small>
  </div>
</nav>


    <div id="login-signup">
        <input class="form-control" type="text" id="username" placeholder="Enter Username" > <br>
        <input class="form-control" type="text" id="password" placeholder="Enter Password" > <br>

        <button class="signup btn btn-primary">Login</button> <br> <br>
    </div>
    <section id="area" >
            <div id="chat"></div>
<section class="footer">
<input type="text" id="message" placeholder="Type your message" oninput="handleTyping()">
<button class="send-message"><svg fill="white" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="mdi mdi-send" width="24" height="24" viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg></button>
</section>
</section>


<div class="modal fade" style="background-color: black !important;" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          <select class="form-control form-control-lg">
  <option>Chatroom 1</option>
  <option>Chatroom 2</option>
  <option>Chatroom 3</option>
  <option>Chatroom 4</option>
  <option disabled>Chatroom 5</option>
</select>
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
<ul class="list-group" id="users">
  <!-- <li class="list-group-item">
        <div class="d-flex flex-column">
        <b>Krish</b>
        <small id="status">...</small>
        </div>-->
  </li>
 
</ul>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



    <script type="text/javascript" src="app.js"></script>
</body>

<script type="text/javascript">
var chatRoomId = "default";
function req(){// The latest spec has updated this method to a promise-based syntax that works like this:
Notification.requestPermission();

// Previously, the syntax was based on a simple callback; this version is now deprecated:
Notification.requestPermission(callback);
}

var config = {
    apiKey: "AIzaSyBxjh9aWtXpq7ki3d8JOCknMtMEbn9Ze5Y",
    authDomain: "re96ev.firebaseapp.com",
    databaseURL: "https://re96ev-default-rtdb.firebaseio.com",
    projectId: "re96ev",
    storageBucket: "re96ev.appspot.com",
    messagingSenderId: "898951921391",
    appId: "1:898951921391:web:adbba9db68380d3ec0651a",
    measurementId: "G-FPP98JDRNZ"
};
firebase.initializeApp(config);
    $("#area").hide();
    document.querySelector('.footer').style.display = "none";
var db = firebase.database();



$(".signup").on("click", function (event) {
    event.preventDefault();

    var username = $("#username").val().trim();
    var password = $("#password").val().trim();

    createUser(username, password);
});

$(".send-message").on("click", function (event) {
    event.preventDefault();
               var inputField = document.getElementById('message');
        inputField.focus();
    var message = $("#message").val().trim();
    var username = getCookie('id');

    if (message && username) {
        sendMessage(username, message);
        $("#message").val(""); // Clear the message input after sending
    } else {
        alert("Please enter a message and log in first");
    }
    
    
    // Assume 'username' and 'chatroomName' are defined earlier

// Reference to the 'users' array inside the 'default' hashmap
const chatroomRef = db.ref(`chatrooms/${chatRoomId}/users`);

// Check if the username exists in the specified path
chatroomRef.once('value')
  .then(snapshot => {
    const users = snapshot.val();
    if (users && Object.values(users).includes(getCookie('id'))) {
    } else {
    chatroomRef.push(getCookie('id'));
    }
  })
  .catch(error => {
    console.error('Error checking username:', error);
  });

    



});

function loginUser(username, password) {
    var userRef = db.ref("members/" + username);

    userRef.once("value")
        .then(function (snapshot) {
            var user = snapshot.val();
            if (user && user.password === password) {
                hideLoginSignup();
                listenForMessages();
                saveCookie('id', username, 365); // Saves 'myCookie' with value 'cookieValue' that expires in 7 days
                saveCookie('pwd', password, 365); 
               // console.log(getCookie("id"));
                var userStatusRef = firebase.database().ref('members/' + username + '/status');
                  firebase.database().ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val()) {
                    userStatusRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);                      userStatusRef.set('online');
                    }
                  });
            } else {
                alert("Invalid username or password");
                deleteCookie('id');
                deleteCookie('pwd');
            }
        })
        .catch(function (error) {
            console.error("Error logging in:", error);
        });
        
}

function createUser(username, password) {
    var userRef = db.ref("members/" + username);

    userRef.once("value")
        .then(function (snapshot) {
            var user = snapshot.val();

            if (user) {
                console.log("User already exists");
                loginUser(username, password);
            } else {
                // Create user
                userRef.set({
                    password: password
                }, function (error) {
                    if (error) {
                        console.error("Error creating user:", error);
                    } else {
                    saveCookie('id', username, 365); // Saves 'myCookie' with value 'cookieValue' that expires in 7 days
                     saveCookie('pwd', password, 365); 
database.ref(`chatrooms/${chatRoomId}/users`).push(username);
                        hideLoginSignup();
                        listenForMessages();
                    }
                });
            }
        })
        .catch(function (error) {
            console.error("Error creating user:", error);
        });
}

function hideLoginSignup() {
    $("#login-signup").hide();
        $("#area").show();
            document.querySelector('.footer').style.display = "flex";
}

function sendMessage(username, message) {
    var chatRef = db.ref("chat/" + chatRoomId);
    var timestamp = firebase.database.ServerValue.TIMESTAMP;

    chatRef.push({
        username: username,
        message: message,
        timestamp: timestamp
    });
}

function listenForMessages() {
    var chatRef = db.ref("chat/"+chatRoomId);

    chatRef.on("child_added", function (snapshot) {
        var message = snapshot.val();
        
        displayMessage(message.username, message.message, message.timestamp);
    });
}

function displayMessage(username, message, timestamp) {
    var chatDiv = document.getElementById("chat");
    var messageDiv_parent = document.createElement("div");

    var messageDiv = document.createElement("div");
if(username  == getCookie("id")){
  messageDiv.classList += "self";
  
}
    // Check for links in the message and convert them to clickable HTML links
    var messageWithLinks = convertLinks(message);

    // If there are no links, use the original message
    messageWithLinks = messageWithLinks || message;

    messageDiv.innerHTML =
        "<b>" + username + ":</b> " + messageWithLinks + "<span>" + formatDate(timestamp) + "</span>";
    messageDiv_parent.appendChild(messageDiv);

    chatDiv.appendChild(messageDiv_parent);
    scrollToBottom();
    // You may want to enhance this further, such as scrolling to the latest message.
    // For simplicity, this example just appends messages to the chat div.
}

function convertLinks(message) {
    // Regular expression to find URLs within the message
    var urlRegex = /(https?:\/\/[^\s]+)/g;

    // Replace URLs with clickable HTML links
    var messageWithLinks = message.replace(urlRegex, function (url) {
        return '<a href="' + url + '" target="_blank">' + url + '</a>';
    });

    return messageWithLinks;
}


function formatDate(milliseconds) {
  const date = new Date(milliseconds);

  const options = {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  };

  return new Intl.DateTimeFormat('en-US', options).format(date);
}
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
function saveCookie(cname, cvalue, exdays) {
  const d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  let expires = "expires="+ d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}
function cookieExists(name) {
    return document.cookie.split(';').some(cookie => cookie.trim().startsWith(name + '='));
}
function scrollToBottom() {
    var chatDiv = document.getElementById("chat");
    chatDiv.scrollTo(0,chatDiv.scrollHeight);
    window.scrollTo(0, document.body.scrollHeight);

}
function deleteCookie(cookieName) {
  document.cookie = cookieName + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
}

// Example usage:
// Replace 'yourCookieName' with the actual name of the cookie you want to delete


// Reference to the members' status in the database
var currentUserId = getCookie('id');

// Reference to the members' status in the database
//var membersStatusRef = firebase.database().ref('/members');
// Assume 'chatroomName' is defined earlier

// Reference to the 'users' array inside the 'default' hashmap
const usersRef = db.ref(`chatrooms/${chatRoomId}/users`);

// Get all users in the specified path
usersRef.once('value')
  .then(snapshot => {
    const users = snapshot.val();

    if (users) {
      // Iterate over each user
      Object.values(users).forEach(user => {
        
  renderCombinedStatus(users);
        // You can perform any operations within this loop
      });
    } else {
      console.log(`No users found in ${chatroomName}/users`);
    }
  })
  .catch(error => {
    console.error('Error getting users:', error);
  });

// Render combined status string
function renderCombinedStatus(usersStatus) {
      var combinedStatusString = '<li class="list-group-item active"><div class="d-flex flex-column"><b>'+currentUserId+'</b><small id="status">Online</small></div></li>'

  for (var userId in usersStatus) {
    if (userId !== currentUserId) {
      combinedStatusString += '   <li class="list-group-item"><div class="d-flex flex-column"><b>'+userId+'</b><small id="status">'+getLastSeenString(usersStatus[userId].status)+'</small></div></li>'
      //combinedStatusString += userId + ": " + getLastSeenString(usersStatus[userId].status) + ', ';
    }
  }

  // Remove trailing comma and space
  combinedStatusString = combinedStatusString.replace(/, $/, '');

  //console.log(combinedStatusString);
  document.querySelector('#users').innerHTML = combinedStatusString;
  // Update your UI or perform any other action with the combined status string
}

// Set up real-time listener


function getLastSeenString(lastSeenTimestamp) {
  if (lastSeenTimestamp === 'online') {
    return 'Online';
  } else if(lastSeenTimestamp === 'Typing'){
    return 'Typing...';
    
  } else{
    var lastSeenDate = new Date(lastSeenTimestamp);
    var currentDate = new Date();
    var timeDifference = currentDate - lastSeenDate;

    if (timeDifference < 24 * 60 * 60 * 1000) {
      // Less than 24 hours ago
      var formattedTime = lastSeenDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
      return 'Last seen ' + formattedTime;
    } else if (timeDifference < 2 * 24 * 60 * 60 * 1000) {
      // Less than 48 hours ago
      return 'Last seen yesterday ' + lastSeenDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
    } else {
      // More than 48 hours ago
      var formattedDate = lastSeenDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
      var formattedTime = lastSeenDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
      return 'Last seen at' + formattedDate + ' at ' + formattedTime;
    }
  }
}
var userStatusRef = firebase.database().ref('members/' + getCookie('id') );
                  let timeout;
function handleTyping() {
  userStatusRef.update({ status: "Typing"});

  // Use a timeout to detect when the user stops typing
  clearTimeout(timeout);
  
   timeout = setTimeout(() => {
    userStatusRef.update({ status:"online" });
  }, 2000); // Adjust the timeout duration as needed
}
</script>
<script>

if (cookieExists('id')) {
$("#login-signup").hide();
        $('#area').show();
        
const id = getCookie('id');
const pwd = getCookie('pwd');
    loginUser(id, pwd);
}else{
    document.querySelector('.footer').style.display = "none";
}


</script>
</html>
